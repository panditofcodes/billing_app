{% extends 'base.html' %} {% load static %} {% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-primary text-white">
    <h4 class="mb-0">Create Invoice</h4>
  </div>

  <div class="card-body">
    <form method="POST" novalidate>
      {% csrf_token %}

      <div class="row mb-3">
        <div class="col-md-4">
          <label for="invoice_no" class="form-label">Invoice No</label>
          <input
            type="text"
            id="invoice_no"
            name="invoice_no"
            class="form-control"
            placeholder="Auto-generated"
            readonly
          />
        </div>

        <div class="col-md-4">
          <label for="company" class="form-label">Company</label>
          <select id="company" name="company" class="form-select" required>
            <option value="" disabled selected>Select Company</option>
            {% for company in companies %}
            <option value="{{ company.id }}">{{ company.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label for="customer" class="form-label">Customer</label>
          <select id="customer" name="customer" class="form-select" required>
            <option value="" disabled selected>Select Customer</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <hr class="my-4" />

      <h5 class="mb-3">Items</h5>

      <div id="items">
        <div class="row g-3 align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label">Item</label>
            <select name="item" class="form-select item-select" required>
              <option value="" disabled selected>Select Item</option>
              {% for item in items %}
              <option value="{{ item.id }}" data-price="{{ item.rate }}">
                {{ item.name }} (â‚¹{{ item.rate }})
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Quantity</label>
            <input
              type="number"
              name="quantity"
              value="1"
              class="form-control quantity-input"
              min="1"
              required
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">GST %</label>
            <input
              type="number"
              name="gst_percent"
              class="form-control gst-input"
              value="18"
              step="0.01"
            />
          </div>
        </div>
      </div>

      <hr />

      <div class="row mt-3">
        <div class="col-md-4">
          <label class="form-label">Subtotal</label>
          <input type="text" id="subtotal" class="form-control" readonly />
        </div>
        <div class="col-md-4">
          <label class="form-label">GST Total</label>
          <input type="text" id="gst_total" class="form-control" readonly />
        </div>
        <div class="col-md-4">
          <label class="form-label">Grand Total</label>
          <input type="text" id="grand_total" class="form-control" readonly />
        </div>
      </div>

      <button type="submit" class="btn btn-success mt-3">Save Invoice</button>
      <a href="#" class="btn btn-secondary mt-3">Cancel</a>
    </form>
  </div>
</div>

<script>
  // Auto-generate Invoice No (simple sequential number based on date/time)
  document.addEventListener("DOMContentLoaded", function () {
    const now = new Date();
    const invNo = `INV-${now.getFullYear()}${(now.getMonth() + 1)
      .toString()
      .padStart(2, "0")}${now
      .getDate()
      .toString()
      .padStart(
        2,
        "0"
      )}-${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
    document.getElementById("invoice_no").value = invNo;
  });

  // Function to calculate totals dynamically
  function calculateTotals() {
    let subtotal = 0;
    let gstRate = parseFloat(document.querySelector(".gst-input").value) || 0;

    const itemSelect = document.querySelector(".item-select");
    const selectedOption = itemSelect.selectedOptions[0];
    const price = selectedOption ? parseFloat(selectedOption.dataset.price) : 0;

    const quantity =
      parseFloat(document.querySelector(".quantity-input").value) || 0;
    subtotal = price * quantity;

    const gstTotal = subtotal * (gstRate / 100);
    const grandTotal = subtotal + gstTotal;

    document.getElementById("subtotal").value = subtotal.toFixed(2);
    document.getElementById("gst_total").value = gstTotal.toFixed(2);
    document.getElementById("grand_total").value = grandTotal.toFixed(2);
  }

  // Initial calculation
  calculateTotals();

  // Event listeners
  document
    .querySelectorAll(".quantity-input, .item-select, .gst-input")
    .forEach((el) => {
      el.addEventListener("input", calculateTotals);
      el.addEventListener("change", calculateTotals);
    });
</script>
{% endblock %}
