{% extends 'base.html' %} {% load static %} {% block content %}

<div class="card shadow-lg border-0 mt-4">
  <div
    class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
  >
    <h4 class="mb-0">Add Customer</h4>
    <a href="{% url 'customer_list' %}" class="btn btn-light btn-sm">
      <i class="bi bi-arrow-left"></i> Back to List
    </a>
  </div>

  <div class="card-body">
    <form method="POST" id="customerForm" novalidate>
      {% csrf_token %}
      <div class="row g-3">
        <!-- Customer Name -->
        <div class="col-md-6">
          <label
            for="{{ form.name.id_for_label }}"
            class="form-label fw-semibold"
            >Customer Name</label
          >
          {{ form.name }}
        </div>

        <!-- GST Number -->
        <div class="col-md-6">
          <label
            for="{{ form.gst_number.id_for_label }}"
            class="form-label fw-semibold"
            >GST Number</label
          >
          {{ form.gst_number }}
        </div>

        <!-- Address -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Address</label>
          <div class="input-group">
            {{ form.address }}
            <button
              type="button"
              class="btn btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#addressModal"
            >
              + Add Address
            </button>
          </div>
        </div>

        <!-- Contact -->
        <div class="col-md-6">
          <label class="form-label fw-semibold">Contact</label>
          <div class="input-group">
            {{ form.contact }}
            <button
              type="button"
              class="btn btn-outline-primary"
              data-bs-toggle="modal"
              data-bs-target="#contactModal"
            >
              + Add Contact
            </button>
          </div>
        </div>
      </div>

      <div class="mt-4 d-flex justify-content-end gap-2">
        <a href="{% url 'customer_list' %}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-save"></i> Save
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Address Modal -->
<div
  class="modal fade"
  id="addressModal"
  tabindex="-1"
  aria-labelledby="addressModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Address</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addAddressForm">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Address Line</label>
              <input type="text" name="line1" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">City</label>
              <input type="text" name="city" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">State</label>
              <input type="text" name="state" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Pincode</label>
              <input type="text" name="pincode" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Country</label>
              <input type="text" name="country" class="form-control" required />
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-success">Save</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Contact Modal -->
<div
  class="modal fade"
  id="contactModal"
  tabindex="-1"
  aria-labelledby="contactModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Contact</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="text" name="phone" class="form-control" required />
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-success">Save</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addressSelect = document.getElementById("id_address");
    const contactSelect = document.getElementById("id_contact");

    // Address AJAX
    document
      .getElementById("addAddressForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const csrfToken = this.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;
        const data = new FormData(this);
        fetch("{% url 'address_create_ajax' %}", {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: data,
        })
          .then((res) => res.json())
          .then((res) => {
            if (!res.error) {
              const option = document.createElement("option");
              option.value = res.id;
              option.text = res.line1 + " - " + res.city;
              addressSelect.add(option);
              addressSelect.value = res.id;
              bootstrap.Modal.getInstance(
                document.getElementById("addressModal")
              ).hide();
              this.reset();
            }
          });
      });

    // Contact AJAX
    document
      .getElementById("addContactForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const csrfToken = this.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;
        const data = new FormData(this);
        fetch("{% url 'contact_create_ajax' %}", {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: data,
        })
          .then((res) => res.json())
          .then((res) => {
            if (!res.error) {
              const option = document.createElement("option");
              option.value = res.id;
              option.text = res.email + " / " + res.phone;
              contactSelect.add(option);
              contactSelect.value = res.id;
              bootstrap.Modal.getInstance(
                document.getElementById("contactModal")
              ).hide();
              this.reset();
            }
          });
      });
  });
</script>

{% endblock %}
