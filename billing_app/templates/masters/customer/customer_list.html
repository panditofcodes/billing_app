{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Customers</h2>
  <a href="{% url 'customer_create' %}" class="btn btn-success">
    <i class="bi bi-plus-lg"></i> Add Customer
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Customer List</span>
    <input
      type="text"
      id="searchInput"
      class="form-control form-control-sm w-auto"
      placeholder="Search..."
    />
  </div>
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-primary">
        <tr>
          <th>Name</th>
          <th>Address</th>
          <th>Contact</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="customerTable">
        {% for customer in customers %}
        <tr class="align-middle" style="cursor: pointer;">
          <!-- Name -->
          <td onclick="window.location.href='{% url 'customer_detail' customer.id %}'">
            {{ customer.name }}
          </td>

          <!-- Address -->
          <td onclick="window.location.href='{% url 'customer_detail' customer.id %}'">
            {% if customer.address %}
              <i class="bi bi-geo-alt-fill me-1"></i>
              {{ customer.address.line1 }}{% if customer.address.city %}, {{ customer.address.city }}{% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <!-- Contact -->
          <td onclick="window.location.href='{% url 'customer_detail' customer.id %}'">
            {% if customer.contact %}
              <i class="bi bi-envelope-fill me-1"></i> {{ customer.contact.email|default:"-" }}<br>
              <i class="bi bi-telephone-fill me-1"></i> {{ customer.contact.phone|default:"-" }}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <!-- Actions -->
          <td class="text-center">
            <a
              href="{% url 'customer_edit' customer.id %}"
              class="btn btn-outline-primary btn-sm me-1"
              title="Edit"
            >
              <i class="bi bi-pencil"></i>
            </a>
            <!-- Delete Button triggers modal -->
            <button
              class="btn btn-outline-danger btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal{{ customer.id }}"
              title="Delete"
            >
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal{{ customer.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ customer.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel{{ customer.id }}"><i class="bi bi-exclamation-triangle-fill"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete <strong>{{ customer.name }}</strong>?
              </div>
              <div class="modal-footer">
                <form method="POST" action="{% url 'customer_delete' customer.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Yes, Delete</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        {% empty %}
        <tr>
          <td colspan="4" class="text-center py-5 text-muted">
            <i class="bi bi-people fs-1"></i>
            <div class="mt-2">No customers found.</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Simple client-side search filter
  const searchInput = document.getElementById("searchInput");
  const tableRows = document.querySelectorAll("#customerTable tr");

  searchInput.addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    tableRows.forEach((row) => {
      const cells = row.querySelectorAll("td");
      let match = false;
      cells.forEach((cell) => {
        if (cell.textContent.toLowerCase().includes(filter)) match = true;
      });
      row.style.display = match ? "" : "none";
    });
  });
</script>

{% endblock %}
