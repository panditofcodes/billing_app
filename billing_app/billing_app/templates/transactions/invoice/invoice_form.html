{% extends 'base_form.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Create Invoice{% endblock %}
{% block form_title %}Create Invoice{% endblock %}
{% block form_icon %}bi bi-receipt{% endblock %}

{% block form_content %}
<form method="post" class="needs-validation" novalidate>
  {% csrf_token %}

  <div class="row g-3">
    <!-- Invoice Info -->
    <div class="col-md-6">
      <label class="form-label fw-semibold">Invoice No</label>
      <input type="text" name="invoice_no" id="invoice_no" class="form-control" readonly>
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Company</label>
      <select name="company" class="form-select" required>
        <option value="">Select Company</option>
        {% for company in companies %}
          <option value="{{ company.id }}">{{ company.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Customer</label>
      <select name="customer" class="form-select" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}">{{ customer.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <hr class="my-4">

  <!-- Items Table -->
  <h5 class="fw-semibold mb-3">Items</h5>
  <div id="items-container">
    <div class="row g-3 align-items-end item-row">
      <div class="col-md-5">
        <label class="form-label">Item</label>
        <select name="item" class="form-select item-select" required>
          <option value="">Select Item</option>
          {% for item in items %}
            <option value="{{ item.id }}" data-price="{{ item.price }}" data-gst="{{ item.gst_rate }}">
              {{ item.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Quantity</label>
        <input type="number" name="quantity" class="form-control qty-input" value="1" min="1" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Price</label>
        <input type="text" class="form-control price-display" readonly>
      </div>

      <div class="col-md-1 d-flex justify-content-center">
        <button type="button" class="btn btn-outline-danger remove-item mt-4">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <button type="button" id="add-item" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-plus-circle"></i> Add Item
    </button>
  </div>

  <hr class="my-4">

  <!-- Totals -->
  <div class="row g-3">
    <div class="col-md-4 ms-auto">
      <div class="card border-0 bg-light">
        <div class="card-body">
          <p class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <strong id="subtotal">₹0.00</strong>
          </p>
          <p class="d-flex justify-content-between mb-2">
            <span>GST Total:</span>
            <strong id="gst_total">₹0.00</strong>
          </p>
          <p class="d-flex justify-content-between mb-0 border-top pt-2">
            <span>Grand Total:</span>
            <strong id="grand_total">₹0.00</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-end">
    <button type="submit" class="btn btn-primary px-4">
      <i class="bi bi-save me-1"></i> Save Invoice
    </button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // === Auto-generate invoice number ===
  function generateInvoiceNumber() {
    const today = new Date();
    const datePart = today.toISOString().slice(0, 10).replace(/-/g, ""); // YYYYMMDD
    const randomPart = Math.floor(100 + Math.random() * 900); // random 3-digit number
    return `INV-${datePart}-${randomPart}`;
  }
  document.getElementById("invoice_no").value = generateInvoiceNumber();

  // === Handle Items ===
  const container = document.getElementById("items-container");
  const addItemBtn = document.getElementById("add-item");

  // Add new item row
  addItemBtn.addEventListener("click", () => {
    const newRow = container.querySelector(".item-row").cloneNode(true);
    newRow.querySelectorAll("input, select").forEach(el => {
      if (el.name === "quantity") el.value = 1;
      if (el.classList.contains("price-display")) el.value = "";
      if (el.tagName === "SELECT") el.selectedIndex = 0;
    });
    container.appendChild(newRow);
  });

  // Remove item row
  container.addEventListener("click", (e) => {
    if (e.target.closest(".remove-item")) {
      const rows = container.querySelectorAll(".item-row");
      if (rows.length > 1) e.target.closest(".item-row").remove();
      calculateTotals();
    }
  });

  // Recalculate on change
  container.addEventListener("change", (e) => {
    if (e.target.matches(".item-select, .qty-input")) calculateTotals();
  });

  // === Calculate Totals ===
  function calculateTotals() {
    let subtotal = 0, gstTotal = 0;

    container.querySelectorAll(".item-row").forEach(row => {
      const itemSelect = row.querySelector(".item-select");
      const qtyInput = row.querySelector(".qty-input");
      const priceDisplay = row.querySelector(".price-display");

      const price = parseFloat(itemSelect.selectedOptions[0]?.dataset.price || 0);
      const gst = parseFloat(itemSelect.selectedOptions[0]?.dataset.gst || 0);
      const qty = parseFloat(qtyInput.value) || 0;

      const lineTotal = price * qty;
      const gstAmount = (lineTotal * gst) / 100;

      subtotal += lineTotal;
      gstTotal += gstAmount;

      priceDisplay.value = lineTotal.toFixed(2);
    });

    document.getElementById("subtotal").textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById("gst_total").textContent = `₹${gstTotal.toFixed(2)}`;
    document.getElementById("grand_total").textContent = `₹${(subtotal + gstTotal).toFixed(2)}`;
  }
});
</script>
{% endblock %}
