{% extends 'base_form.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Create Invoice{% endblock %}
{% block form_title %}Create Invoice{% endblock %}
{% block form_icon %}bi bi-receipt{% endblock %}

{% block form_content %}
<form id="mainForm" method="post" class="needs-validation" novalidate>
  {% csrf_token %}

  <div class="row g-3">
    <!-- Invoice Info -->
    <div class="col-md-6">
      <label class="form-label fw-semibold">Invoice No</label>
      <input
        type="text"
        name="invoice_no"
        id="invoice_no"
        class="form-control"
        readonly
        value="{% if invoice %}{{ invoice.invoice_number }}{% endif %}"
      >
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Company</label>
      <select name="company" class="form-select" required>
        <option value="">Select Company</option>
        {% for company in companies %}
          <option value="{{ company.id }}"
            {% if invoice and invoice.company_id == company.id %}selected{% endif %}
          >{{ company.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Customer</label>
      <select name="customer" class="form-select" required>
        <option value="">Select Customer</option>
        {% for customer in customers %}
          <option value="{{ customer.id }}"
            {% if invoice and invoice.customer_id == customer.id %}selected{% endif %}
          >{{ customer.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <hr class="my-4">

  <!-- Items Table -->
  <h5 class="fw-semibold mb-3">Items</h5>

  {# container carries JSON for edit mode; JS will render rows inside it #}
  <div id="items-container" data-lines='{{ line_items_json|default:"[]" }}'></div>

  <div class="mt-3">
    <button type="button" id="add-item" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-plus-circle"></i> Add Item
    </button>
  </div>

  <hr class="my-4">

  <!-- Totals -->
  <div class="row g-3">
    <div class="col-md-4 ms-auto">
      <div class="card border-0 bg-light">
        <div class="card-body">
          <p class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <strong id="subtotal">₹0.00</strong>
          </p>
          <p class="d-flex justify-content-between mb-2">
            <span>GST Total:</span>
            <strong id="gst_total">₹0.00</strong>
          </p>
          <p class="d-flex justify-content-between mb-0 border-top pt-2">
            <span>Grand Total:</span>
            <strong id="grand_total">₹0.00</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-end">
    <button type="submit" class="btn btn-primary px-4">
      <i class="bi bi-save me-1"></i> Save Invoice
    </button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- invoice number: only generate if blank (create mode) ---
  const invoiceInput = document.getElementById("invoice_no");
  if (!invoiceInput.value) {
    const today = new Date();
    const datePart = today.toISOString().slice(0,10).replace(/-/g,'');
    invoiceInput.value = `INV-${datePart}-${Math.floor(100 + Math.random()*900)}`;
  }

  // --- Prepare items metadata from template context ---
  const itemsList = [
    {% for it in items %}
      { id: "{{ it.id }}", name: "{{ it.name|escapejs }}", price: "{{ it.price }}", gst: "{{ it.gst_rate|default:0 }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const container = document.getElementById("items-container");
  const addItemBtn = document.getElementById("add-item");
  const initialLines = JSON.parse(container.dataset.lines || "[]");

  // build <select name="item"> element
  function buildSelectElement(selectedId) {
    const sel = document.createElement("select");
    sel.name = "item";
    sel.className = "form-select item-select";
    sel.required = true;

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select Item";
    sel.appendChild(opt0);

    itemsList.forEach(i => {
      const o = document.createElement("option");
      o.value = i.id;
      o.textContent = i.name;
      o.dataset.price = i.price;
      o.dataset.gst = i.gst;
      sel.appendChild(o);
    });

    if (selectedId) sel.value = selectedId;
    return sel;
  }

  // create a single item row (data optional). Adds hidden line_id for edit rows.
  function createRow(data) {
    const row = document.createElement("div");
    row.className = "row g-3 align-items-end item-row mb-2";

    // hidden line id (for edits)
    const lineIdInput = document.createElement("input");
    lineIdInput.type = "hidden";
    lineIdInput.name = "line_id";
    lineIdInput.value = data && data.line_id ? data.line_id : "";
    row.appendChild(lineIdInput);

    // item select col
    const c1 = document.createElement("div"); c1.className = "col-md-5";
    const lbl1 = document.createElement("label"); lbl1.className = "form-label"; lbl1.textContent = "Item";
    c1.appendChild(lbl1);
    const sel = buildSelectElement(data ? data.item_id : null);
    c1.appendChild(sel);

    // quantity col
    const c2 = document.createElement("div"); c2.className = "col-md-3";
    const lbl2 = document.createElement("label"); lbl2.className = "form-label"; lbl2.textContent = "Quantity";
    c2.appendChild(lbl2);
    const qty = document.createElement("input");
    qty.type = "number";
    qty.name = "quantity";
    qty.className = "form-control qty-input";
    qty.min = 1;
    qty.required = true;
    qty.value = data ? data.qty : 1;
    c2.appendChild(qty);

    // price col
    const c3 = document.createElement("div"); c3.className = "col-md-3";
    const lbl3 = document.createElement("label"); lbl3.className = "form-label"; lbl3.textContent = "Price";
    c3.appendChild(lbl3);
    const price = document.createElement("input");
    price.type = "text";
    price.name = "price";
    price.className = "form-control price-display";
    price.readOnly = true;
    price.value = data && data.price ? parseFloat(data.price).toFixed(2) : "";
    c3.appendChild(price);

    // remove button
    const c4 = document.createElement("div"); c4.className = "col-md-1 d-flex justify-content-center";
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-outline-danger remove-item";
    btn.innerHTML = '<i class="bi bi-trash"></i>';
    c4.appendChild(btn);

    row.appendChild(c1);
    row.appendChild(c2);
    row.appendChild(c3);
    row.appendChild(c4);

    container.appendChild(row);

    // ensure price display is correct
    recalcRow(row);
    return row;
  }

  function recalcRow(row) {
    const sel = row.querySelector(".item-select");
    const qty = row.querySelector(".qty-input");
    const priceInput = row.querySelector(".price-display");
    const pricePer = parseFloat(sel.selectedOptions[0]?.dataset.price || 0);
    const qtyVal = parseFloat(qty.value || 0);
    priceInput.value = (pricePer * qtyVal) ? (pricePer * qtyVal).toFixed(2) : "";
    calculateTotals();
  }

  function calculateTotals() {
    let subtotal = 0, gstTotal = 0;
    container.querySelectorAll(".item-row").forEach(row => {
      const sel = row.querySelector(".item-select");
      const qty = parseFloat(row.querySelector(".qty-input").value || 0);
      const pricePer = parseFloat(sel.selectedOptions[0]?.dataset.price || 0);
      const gst = parseFloat(sel.selectedOptions[0]?.dataset.gst || 0);
      const lineTotal = pricePer * qty;
      const gstAmt = (lineTotal * gst) / 100;
      subtotal += lineTotal;
      gstTotal += gstAmt;
      const priceDisplay = row.querySelector(".price-display");
      if (!priceDisplay.value) priceDisplay.value = lineTotal ? lineTotal.toFixed(2) : "";
    });

    document.getElementById("subtotal").textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById("gst_total").textContent = `₹${gstTotal.toFixed(2)}`;
    document.getElementById("grand_total").textContent = `₹${(subtotal + gstTotal).toFixed(2)}`;
  }

  // render initial rows from server data (edit) or one blank row
  container.innerHTML = "";
  if (initialLines.length) {
    initialLines.forEach(l => createRow(l));
  } else {
    createRow(null);
  }

  // events
  addItemBtn.addEventListener("click", () => createRow(null));

  container.addEventListener("change", (e) => {
    const row = e.target.closest(".item-row");
    if (!row) return;
    if (e.target.matches(".item-select") || e.target.matches(".qty-input")) recalcRow(row);
  });

  container.addEventListener("click", (e) => {
    if (e.target.closest(".remove-item")) {
      const rows = container.querySelectorAll(".item-row");
      if (rows.length > 1) e.target.closest(".item-row").remove();
      else {
        const r = e.target.closest(".item-row");
        r.querySelector(".item-select").value = "";
        r.querySelector(".qty-input").value = 1;
        r.querySelector(".price-display").value = "";
        // clear line_id for the single remaining row
        const hid = r.querySelector('input[name="line_id"]');
        if (hid) hid.value = "";
      }
      calculateTotals();
    }
  });

  calculateTotals();
});
</script>
{% endblock %}
