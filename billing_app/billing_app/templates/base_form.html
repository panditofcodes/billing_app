{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">{{ title }}</h4>
    <div>
      <a href="{{ list_url }}" class="btn btn-outline-secondary me-2">
        <i class="bi bi-arrow-left"></i> Back to List
      </a>
      <button type="submit" form="mainForm" class="btn btn-primary">
        <i class="bi bi-save"></i> Save
      </button>
    </div>
  </div>

  <div class="card shadow-sm border-0 p-4">
    {% block form_content %}{% endblock %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Save Address
  document.querySelector("#addressForm")?.addEventListener("submit", function (e) {
    e.preventDefault();
    fetch("{% url 'address_create_ajax' %}", {
      method: "POST",
      headers: { "X-CSRFToken": this.querySelector('[name=csrfmiddlewaretoken]').value },
      body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
      if (data.id) {
        const select = document.querySelector("select[name='address']");
        const option = new Option(`${data.line1}, ${data.city}`, data.id, true, true);
        select.append(option);
        bootstrap.Modal.getInstance(document.getElementById("addressModal")).hide();
        this.reset();
      } else {
        alert("Error saving address!");
      }
    });
  });

  // Save Contact
  document.querySelector("#contactForm")?.addEventListener("submit", function (e) {
    e.preventDefault();
    fetch("{% url 'contact_create_ajax' %}", {
      method: "POST",
      headers: { "X-CSRFToken": this.querySelector('[name=csrfmiddlewaretoken]').value },
      body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
      if (data.id) {
        const select = document.querySelector("select[name='contact']");
        const label = data.phone || data.email || "New Contact";
        const option = new Option(label, data.id, true, true);
        select.append(option);
        bootstrap.Modal.getInstance(document.getElementById("contactModal")).hide();
        this.reset();
      } else {
        alert("Error saving contact!");
      }
    });
  });
});
</script>
{% endblock %}